<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="Content-Language" content="en-us">
	<title>Example Web Editor</title>
	<link rel="stylesheet" type="text/css" href="xtext/2.25.0/xtext-ace.css" />
	<link rel="stylesheet" type="text/css" href="./styles/style.css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
	<script src="https://unpkg.com/blockly/blockly.min.js"></script>
	<script src="webjars/requirejs/2.3.6/require.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://unpkg.com/mathjs@13.2.0/"></script>
	<script src="./scripts/imports.js" defer></script>
	<script src="./scripts/generators/bdd.js" defer></script>
	<script src="./scripts/generators/blockGenerator.js" defer></script>
	<script src="./scripts/script.js" defer></script>
	<script src="./scripts/RobViz/computeJointPositions.js" defer></script>
	<script>
		$(document).ready(function () {
			// WHYLINE
			const whylineData2 = [
				{ type: "node", value: "Why did that not happen" },
				{ type: "connector", value: "true" },
				{ type: "node", value: "Hejsa med dig" },
				{ type: "connector", value: "false" },
				{ type: "node", value: "Ooooogooanb" },
				{ type: "connector", value: "true" },
				{ type: "node", value: "Hejsa med dig" },
				{ type: "connector", value: "false" },
				{ type: "node", value: "Ooooogooanb" },
				{ type: "connector", value: "true" },
				{ type: "node", value: "Hejsa med dig" },
				{ type: "connector", value: "false" },
				{ type: "node", value: "Ooooogooanb" },
			];

			const $whyline = $('#whyline');
			whylineData2.forEach(item => {
				if (item.type === "node") {
					const $node = $('<div>').addClass('whyline-node').text(item.value);
					$whyline.append($node);
				} else if (item.type === "connector") {
					const $connector = $('<div>').addClass('whyline-connector');
					const $text = $('<span>').text(item.value);
					$connector.append($text);
					$whyline.append($connector);
				}
			});
			
			// 3D VISUALIZATION
			const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf5f5f5);
        const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(500, 500);
	    $("#three-d-container").append(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 10);
        scene.add(directionalLight);

        // Materials
        const jointMaterial = new THREE.MeshPhongMaterial({ color: 0x4a90e2 });
        const lineMaterial = new THREE.LineBasicMaterial({ color: 0x999999 });
        const historyLineMaterial = new THREE.LineBasicMaterial({ color: 0xff0000 }); // Red line for history

        // List of different robot positions (6 sets of coordinates)
        const robotPositionsList = [
            [
                [0, 0, 0],        // Base
                [0, 1.5, 0],      // Shoulder
                [0, 3, 1],        // Elbow
                [0.5, 4, 1.5],    // Wrist 1
                [0.5, 4.5, 1.5],  // Wrist 2
                [0.5, 5, 1.5]     // End effector
            ],
            [
                [0, 0, 0],
                [0, 1.5, 0.5],
                [0, 3, 1.5],
                [1, 4, 2],
                [1, 4.5, 2],
                [1, 5, 2]
            ],
            [
                [0, 0, 0],
                [0.5, 1.5, 1],
                [1, 3, 2],
                [1.5, 4, 2.5],
                [1.5, 4.5, 2.5],
                [1.5, 5, 2.5]
            ],
            [
                [0, 0, 0],
                [1, 1.5, 1],
                [2, 3, 1.5],
                [2, 4, 2],
                [2, 4.5, 2],
                [2, 5, 2]
            ],
            [
                [0, 0, 0],
                [0.5, 1.5, 0.5],
                [1, 3, 1],
                [1, 4, 1.5],
                [1, 4.5, 1.5],
                [1, 5, 1.5]
            ],
            [
                [0, 0, 0],
                [0, 1.5, 0],
                [0, 3, 1],
                [0.5, 4, 1.5],
                [0.5, 4.5, 1.5],
                [0.5, 5, 1.5]
            ]
        ];

        let currentPositionIndex = 0;
        const endEffectorHistory = [];

        function createJoint(position) {
            const geometry = new THREE.SphereGeometry(0.2, 32, 32);
            const joint = new THREE.Mesh(geometry, jointMaterial);
            joint.position.set(position[0], position[1], position[2]);
            return joint;
        }

        function createLine(startPoint, endPoint) {
            const geometry = new THREE.BufferGeometry().setFromPoints([
                new THREE.Vector3(startPoint[0], startPoint[1], startPoint[2]),
                new THREE.Vector3(endPoint[0], endPoint[1], endPoint[2])
            ]);
            return new THREE.Line(geometry, lineMaterial);
        }

        function createHistoryLine(points) {
            const vectors = points.map(p => new THREE.Vector3(p[0], p[1], p[2]));
            const geometry = new THREE.BufferGeometry().setFromPoints(vectors);
            return new THREE.Line(geometry, historyLineMaterial);
        }

        let joints = [];
        let lines = [];
        let historyLine = null;

        function updateRobotPosition() {
            // Remove existing joints and lines
            joints.forEach(joint => scene.remove(joint));
            lines.forEach(line => scene.remove(line));
            if (historyLine) scene.remove(historyLine);

            joints = [];
            lines = [];

            const currentPosition = robotPositionsList[currentPositionIndex];

            // Add new joints
            currentPosition.forEach(position => {
                const joint = createJoint(position);
                scene.add(joint);
                joints.push(joint);
            });

            // Add connecting lines between joints
            for (let i = 0; i < currentPosition.length - 1; i++) {
                const line = createLine(currentPosition[i], currentPosition[i + 1]);
                scene.add(line);
                lines.push(line);
            }

            // Add end effector position to history
            const endEffector = currentPosition[currentPosition.length - 1];
            endEffectorHistory.push(endEffector);

            // Create history line
            historyLine = createHistoryLine(endEffectorHistory);
            scene.add(historyLine);

            // Update position index
            currentPositionIndex = (currentPositionIndex + 1) % robotPositionsList.length;
        }

        // Camera position
        camera.position.set(6, 4, 6);
        camera.lookAt(0, 2.5, 0);

        // Animation
        let lastUpdate = 0;
        const updateInterval = 1000; // Update every 1 second

        function animate(timestamp) {
            requestAnimationFrame(animate);
            
            // Update robot position every second
            if (timestamp - lastUpdate > updateInterval) {
                updateRobotPosition();
                lastUpdate = timestamp;
            }
            
            // Rotate scene
            scene.rotation.y += 0.005;
            
            renderer.render(scene, camera);
        }

        animate();

		});
	</script>
</head>

<body>
	<div class="container">
		<div class="header">
			<h1>Editor for BDD Scenarios</h1>
			<span class=file-name> <label for="fileName">File name</label>
				<input id="fileName" type="text" maxlength="35" />
		</div>
		<div class="editor-tab">
			<span id="entity-tab" data-editor-id="xtext-editor-entities" class="tab">Entities</span> <span
				id="scenario-tab" data-editor-id="xtext-editor-scenarios" class="tab">Scenarios</span>
			<span id="warning-message" style="color: red; visibility: hidden;">Entities
				should be defined first.</span>
		</div>
		<div class="content-stack">
			<div class="content">
				<div class="xtext-wrapper">
					<div id="xtext-editor-scenarios" class="xtext-editor" style="display: none"
						data-editor-resource-id="multi-resource/scenarios.bdd" data-editor-xtext-lang="bdd"></div>
					<div id="xtext-editor-entities" class="xtext-editor" style="display: block"
						data-editor-resource-id="multi-resource/widgets.bdd" data-editor-xtext-lang="bdd"></div>
				</div>
				<div class="blockly" id="blockly-editor" style="display: block;"></div>
				<div class="blockly" id="blockly-editor2" style="display: none;"></div>
			</div>
			<div class="whyline-container">
				<h2 class="container-header">Whyline</h2>
				<div id="whyline"></div>
			</div>
			<div class="three-d-container">
				<h2 class="container-header">3D Replay</h2>
				<div id="three-d-container"></div>
			</div>
		</div>
		<div class="buttons">
			<button id="save-button" value="Save" title="Save">Save</button>
			<input id="file-input" type="file" style="display: none;" />
			<button id="load-button" value="Load" title="Load">Load</button>
			<button id="get-ast">Get ast</button>
			<button id="save-scenario" onclick="saveScenario()">Save
				Scenario</button>
			<!-- <button id="save-entities" onclick="saveEntities()">Save Entities</button> -->
			<button id="run-scenario" onclick="runScenario()">Run
				Scenario</button>
		</div>
	</div>
</body>

</html>